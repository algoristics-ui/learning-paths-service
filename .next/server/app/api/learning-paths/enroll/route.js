"use strict";(()=>{var e={};e.id=833,e.ids=[833],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},7261:e=>{e.exports=require("node:util")},4292:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>E,patchFetch:()=>I,requestAsyncStorage:()=>g,routeModule:()=>c,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h});var t={};s.r(t),s.d(t,{POST:()=>p});var n=s(9303),a=s(8716),o=s(670),i=s(7070),l=s(4328),d=s(7435),u=s(9178);async function p(e){try{let r=await (0,u.S)(e),{pathId:s}=await e.json();if(!s||isNaN(parseInt(s)))return i.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"Valid pathId is required"}},{status:400});d.k.info(`Enrolling user in learning path: userId=${r.userId}, organizationId=${r.organizationId}, pathId=${s}`);let t=`
      SELECT id, title FROM learning_paths 
      WHERE id = $1 AND organization_id = $2
    `,n=await (0,l.I)(t,[s,r.organizationId]);if(0===n.rows.length)return i.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:"Learning path not found"}},{status:404});let a=`
      SELECT id FROM user_enrollments 
      WHERE user_id = $1 AND path_id = $2
    `;if((await (0,l.I)(a,[r.userId,s])).rows.length>0)return i.NextResponse.json({success:!1,error:{code:"ALREADY_ENROLLED",message:"User is already enrolled in this learning path"}},{status:409});let o=`
      INSERT INTO user_enrollments (user_id, path_id, status, progress, completed_courses, enrolled_at, last_activity)
      VALUES ($1, $2, 'in_progress', 0, 0, NOW(), NOW())
      RETURNING enrolled_at
    `,p=await (0,l.I)(o,[r.userId,s]),c=`
      INSERT INTO user_course_progress (user_id, course_id, status, started_at, updated_at)
      SELECT $1, c.id, 'available', NOW(), NOW()
      FROM courses c
      JOIN milestones m ON c.milestone_id = m.id
      WHERE m.path_id = $2 AND m.order_index = 1 AND c.order_index = 1
    `;await (0,l.I)(c,[r.userId,s]);let g=p.rows[0].enrolled_at;return d.k.info(`User enrolled successfully: userId=${r.userId}, pathId=${s}, enrolledAt=${g}`),i.NextResponse.json({success:!0,message:"Successfully enrolled in learning path",data:{pathId:parseInt(s),userId:r.userId,enrolledAt:g,status:"in_progress"}})}catch(e){if(d.k.error(`Error enrolling user in learning path: ${e.message}`),"Missing Bearer token"===e.message||"Invalid token"===e.message)return i.NextResponse.json({success:!1,error:{code:"UNAUTHORIZED",message:e.message}},{status:401});return i.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to enroll in learning path"}},{status:500})}}let c=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/learning-paths/enroll/route",pathname:"/api/learning-paths/enroll",filename:"route",bundlePath:"app/api/learning-paths/enroll/route"},resolvedPagePath:"/Users/s1dando/LMS-Git/learning-paths-service/app/api/learning-paths/enroll/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:_}=c,E="/api/learning-paths/enroll/route";function I(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},9178:(e,r,s)=>{s.d(r,{S:()=>n});var t=s(6176);async function n(e){let r=e.headers.get("authorization")||"",s=r.startsWith("Bearer ")?r.slice(7):"",n=process.env.JWT_SECRET||"dev_jwt_secret_change_me";if(!s)throw Error("Missing Bearer token");try{let e=new TextEncoder,{payload:r}=await (0,t._)(s,e.encode(n));return{userId:r.userId,organizationId:r.organizationId,email:r.email}}catch{throw Error("Invalid token")}}},4328:(e,r,s)=>{s.d(r,{I:()=>l});let t=require("pg");var n=s(7410);let a=n.z.object({DATABASE_URL:n.z.string().min(1)}),o=process.env.DATABASE_URL?a.parse({DATABASE_URL:process.env.DATABASE_URL}):{DATABASE_URL:process.env.DATABASE_URL||"placeholder"},i=global.pgPoolLearningPaths||new t.Pool({connectionString:o.DATABASE_URL});async function l(e,r){return{rows:(await i.query(e,r)).rows}}global.pgPoolLearningPaths||(global.pgPoolLearningPaths=i)},7435:(e,r,s)=>{s.d(r,{k:()=>o});var t=s(6091);async function n(){let e=process.env.JWT_SECRET||"dev_jwt_secret_change_me",r=new TextEncoder;return await new t.N({sub:"learning-paths-service"}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("10m").sign(r.encode(e))}async function a(e,r){let s=process.env.LOGGING_ENDPOINT||"http://localhost:4010/api/logs",t=await n();try{await fetch(s,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${t}`},body:JSON.stringify({app:"learning-paths-service",level:e,message:r})})}catch{}}let o={info:e=>a("INFO",e),debug:e=>a("DEBUG",e),warn:e=>a("WARN",e),error:e=>a("ERROR",e)}}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[276,972,410,524],()=>s(4292));module.exports=t})();