"use strict";(()=>{var e={};e.id=174,e.ids=[174],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},7261:e=>{e.exports=require("node:util")},7867:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>f,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{POST:()=>l});var i=r(9303),s=r(8716),n=r(670),o=r(7070),d=r(4328),c=r(7435),u=r(9178);async function l(e,{params:t}){try{let r=await (0,u.S)(e),a=parseInt(t.pathId);if(isNaN(a))return o.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid path ID"}},{status:400});c.k.info(`Generating certificate for learning path: userId=${r.userId}, organizationId=${r.organizationId}, pathId=${a}`);let i=`
      SELECT ue.status, ue.progress, lp.title, lp.organization_id
      FROM user_enrollments ue
      JOIN learning_paths lp ON ue.path_id = lp.id
      WHERE ue.user_id = $1 AND ue.path_id = $2 AND lp.organization_id = $3
    `,s=await (0,d.I)(i,[r.userId,a,r.organizationId]);if(0===s.rows.length)return o.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:"Learning path enrollment not found"}},{status:404});let n=s.rows[0];if("completed"!==n.status||n.progress<100)return o.NextResponse.json({success:!1,error:{code:"PREREQUISITES_NOT_MET",message:"Learning path must be completed to generate certificate"}},{status:400});let l=`
      SELECT certificate_id, download_url, issued_at, valid_until
      FROM certificates
      WHERE user_id = $1 AND path_id = $2
    `,p=await (0,d.I)(l,[r.userId,a]);if(p.rows.length>0){let e=p.rows[0];return c.k.info(`Certificate already exists: userId=${r.userId}, pathId=${a}, certificateId=${e.certificate_id}`),o.NextResponse.json({success:!0,data:{certificateId:e.certificate_id,downloadUrl:e.download_url,issuedAt:e.issued_at,validUntil:e.valid_until}})}let g=`cert-${r.userId}-${a}-${Date.now()}`,h=new Date().toISOString(),_=new Date(Date.now()+63072e6).toISOString(),I=`https://storage.example.com/certificates/${g}.pdf`,f=`
      INSERT INTO certificates (certificate_id, user_id, path_id, download_url, issued_at, valid_until)
      VALUES ($1, $2, $3, $4, $5, $6)
      RETURNING certificate_id, download_url, issued_at, valid_until
    `,E=(await (0,d.I)(f,[g,r.userId,a,I,h,_])).rows[0];return c.k.info(`Certificate generated successfully: userId=${r.userId}, pathId=${a}, certificateId=${E.certificate_id}`),o.NextResponse.json({success:!0,data:{certificateId:E.certificate_id,downloadUrl:E.download_url,issuedAt:E.issued_at,validUntil:E.valid_until}})}catch(e){if(c.k.error(`Error generating certificate: ${e.message}, pathId=${t.pathId}`),"Missing Bearer token"===e.message||"Invalid token"===e.message)return o.NextResponse.json({success:!1,error:{code:"UNAUTHORIZED",message:e.message}},{status:401});return o.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to generate certificate"}},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/learning-paths/[pathId]/certificate/route",pathname:"/api/learning-paths/[pathId]/certificate",filename:"route",bundlePath:"app/api/learning-paths/[pathId]/certificate/route"},resolvedPagePath:"/Users/s1dando/LMS-Git/learning-paths-service/app/api/learning-paths/[pathId]/certificate/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:_}=p,I="/api/learning-paths/[pathId]/certificate/route";function f(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},9178:(e,t,r)=>{r.d(t,{S:()=>i});var a=r(6176);async function i(e){let t=e.headers.get("authorization")||"",r=t.startsWith("Bearer ")?t.slice(7):"",i=process.env.JWT_SECRET||"dev_jwt_secret_change_me";if(!r)throw Error("Missing Bearer token");try{let e=new TextEncoder,{payload:t}=await (0,a._)(r,e.encode(i));return{userId:t.userId,organizationId:t.organizationId,email:t.email}}catch{throw Error("Invalid token")}}},4328:(e,t,r)=>{r.d(t,{I:()=>d});let a=require("pg");var i=r(7410);let s=i.z.object({DATABASE_URL:i.z.string().min(1)}),n=process.env.DATABASE_URL?s.parse({DATABASE_URL:process.env.DATABASE_URL}):{DATABASE_URL:process.env.DATABASE_URL||"placeholder"},o=global.pgPoolLearningPaths||new a.Pool({connectionString:n.DATABASE_URL});async function d(e,t){return{rows:(await o.query(e,t)).rows}}global.pgPoolLearningPaths||(global.pgPoolLearningPaths=o)},7435:(e,t,r)=>{r.d(t,{k:()=>n});var a=r(6091);async function i(){let e=process.env.JWT_SECRET||"dev_jwt_secret_change_me",t=new TextEncoder;return await new a.N({sub:"learning-paths-service"}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("10m").sign(t.encode(e))}async function s(e,t){let r=process.env.LOGGING_ENDPOINT||"http://localhost:4010/api/logs",a=await i();try{await fetch(r,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${a}`},body:JSON.stringify({app:"learning-paths-service",level:e,message:t})})}catch{}}let n={info:e=>s("INFO",e),debug:e=>s("DEBUG",e),warn:e=>s("WARN",e),error:e=>s("ERROR",e)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972,410,524],()=>r(7867));module.exports=a})();